<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>статистика коронавируса</title>
  <link rel="stylesheet" href="style.css" />
  <script type="text/javascript" src="https://coronavirus-monitor.ru/jquery-lite-9.js?a=12"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.1/d3.min.js"></script>
  <script type="text/javascript">
    function takeLast(count) {
        return function(d, i, data) { return data.length - i <= count };
    }

    function get(url, params /* @todo */) {
      return fetch(url).then(function(response) { return response.ok ? response.text() : Promise.reject(response) });
    }

//          var dataSourceUrl = 'https://coronavirus-monitor.ru/jquery-lite-9.js?a=12';
//          get(dataSourceUrl).then(function(result) {console.log(result)}, function(result) {console.error(result)});

    function getSourceData() {
        return getOnDocumentReadyPromise().then(function() { return window.dataFromServer || Promise.reject('No data') });
    }

    function getOnDocumentReadyPromise() {
        if (!window.__onDocumentReadyPromise) {
		    window.__onDocumentReadyPromise = new Promise(function(resolve) { window.addEventListener('load', resolve) }); 
        }

        return window.__onDocumentReadyPromise;
    }

    function el(tag, text) {
	    var view = document.createElement(tag);
	    text && view.append(document.createTextNode(text));
	    return view;
    }

    getSourceData().then(function(d) {
        console.info(d);

	    var countries = d.countries.data.countries;

        var dates = Object.keys(countries
            .reduce(function(dates, country) {
                // @side-effect
                country.statisticsHash = country.statistics.reduce(function(dates, entry, i) {
                    dates[entry.date] = Object.assign(entry, {confirmedPerDay: i && entry.confirmed - country.statistics[i-1].confirmed});
                    return dates
                }, {});
                return Object.assign(dates, country.statisticsHash);
            }, {}))
            .sort()
            .filter(takeLast(14));

	    var countriesView = document.querySelector('#countries tbody');
	    var countriesHeadView = document.querySelector('#countries thead tr');
        var LOCALE_RU = 'ru-RU';
        var locale = LOCALE_RU;
        var df = new Intl.NumberFormat(locale, {minimumIntegerDigits: 2});
        var nf = new Intl.NumberFormat(locale);
        var ff = new Intl.NumberFormat(locale, {maximumFractionDigits: 1});

        function toDate(string) { return new Date(string) };

        function formatToDayAndMonth(date) { return df.format(date.getDate())+'.'+df.format(date.getMonth()+1) };

        function toDayAndMonth(string) { return formatToDayAndMonth(toDate(string)) }

        function getConfirmed(data, date, accumulated) {
            return date in data && data[date][accumulated ? 'confirmed' : 'confirmedPerDay'] || null;
        }

        function getCountryConfirmed(country, date, accumulated) {
            return getConfirmed(country.statisticsHash, date, accumulated);
        }

        var totalHash = dates.reduce(function(hash, date) {
            hash[date] = {
                confirmedPerDay: countries.reduce(function(sum, country) { return sum + (getCountryConfirmed(country, date) || 0) }, 0),
                confirmed: countries.reduce(function(sum, country) { return sum + (getCountryConfirmed(country, date, true) || 0) }, 0)
            };
            return hash
        }, {});

        function renderDataRow(country) {
		    var rowView = el('tr');
		    rowView.append(el('td', country.ru));
            dates.forEach(function(date) {
                var confirmed = getCountryConfirmed(country, date, true);
                rowView.append(el('td', 
                confirmed
                    && (
                        nf.format(confirmed)
                        + ' (' + ff.format(100.0 * confirmed / getConfirmed(totalHash, date, true)) + '%)'
                    )
                    || '-')) });
		    countriesView.append(rowView);
        }

// Diagram

        var margin = {top: 20, right: 30, bottom: 30, left: 80};

        var height = 400;
        var width = 2000;

        var x = d3.scaleBand()
            .domain(dates.map(toDayAndMonth))
            .range([margin.left, width - margin.right])
            .padding(0.1)
            //.round(true);

        var RUSSIA_INDEX = 14;

        function constructDiagramForCountry(country) {
            var data = dates.map(function(date) { return {date: date, value: getCountryConfirmed(country, date) || 0} });
            var domainRange = [0, d3.max(data, function(d) { return d.value })];

            var y = d3.scaleLinear()
                .domain(domainRange)
                .range([height - margin.bottom, margin.top]);

            var svg = d3.create("svg")
                  .attr("viewBox", [0, 0, width, height]);

            svg.append("g")
                .attr("fill", "#bbb")
                .selectAll("rect")
                .data(data)
                .join("rect")
                  .attr("x", function(d) { return x(toDayAndMonth(d.date)) })
                  .attr("y", function(d) { return y(d.value); })
                  .attr("width", function (d) { return x.bandwidth() })
                  .attr("height", function(d) { var result = y(domainRange[0]) - y(d.value); return result < 0 ? 0: result });
            
            svg.append("g")
                  .attr("fill", "black")
                  .attr("text-anchor", "middle")
                  .attr("font-family", "sans-serif")
                  .attr("font-size", 12)
                .selectAll("text")
                .data(dates)
                .join("text")
                  .attr("x", function(d) { return x(toDayAndMonth(d)) + x.bandwidth() / 2 })
                  .attr("y", function(d, i) { return y(getCountryConfirmed(country, d)) })
                  .attr("dy", "-0.35em")
                  .text(function(d) { return nf.format(getCountryConfirmed(country, d)) });


            svg.append("g")
                .attr("transform", 'translate(0,'+(height - margin.bottom)+')')
                .call(d3.axisBottom(x));

            svg.append("g")
                .attr("transform", 'translate('+margin.left+',0)')
                .call(d3.axisLeft(y))
//                .call(function(g) { return g.select(".domain").remove() });

            return svg;
        }

//        dates
//            .map(toDayAndMonth)
//            .forEach(function(date) { countriesHeadView.append(el('td', date)) });
//        renderDataRow({ru: 'Всего', statisticsHash: totalHash});
//        countries.forEach(renderDataRow);
        
        function NodeCollectionView(anchor) {
                var lastNode = anchor;
                
                this.append = function(node) {
                    lastNode.insertAdjacentElement('afterend', node);
                    lastNode = node;
                };
        }

        var countryDiagramsView = new NodeCollectionView(document.querySelector('h1'));

        function renderCountryDiagramRow(country) {
            countryDiagramsView.append(el('h2', country.ru));
            countryDiagramsView.append(constructDiagramForCountry(country).node());
        }

        renderCountryDiagramRow({ru: 'Всего', statisticsHash: totalHash});
        countries.forEach(renderCountryDiagramRow);
    }, function(msg) { console.error(msg) });
  </script>
</head>
<body>
	<h1>фактов заражений коронавирусом за сутки</h1>
	<p>Спасибо за данные coronavirus-monitor.ru<p>
	<!--
	<table id="countries">
		<thead>
			<tr>
				<td>страна</td>
			</tr>
		</thead>
		<tbody></tbody>
	</table>
	-->
</body>
</html>
